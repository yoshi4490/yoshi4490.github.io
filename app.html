<!doctype html><html lang="ja"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>経理ラボベース｜学習（サーバ保存対応）</title>
<link rel="icon" href="assets/logo.svg" type="image/svg+xml">
<style>
:root{--bg:#f7fbff;--ink:#0f172a;--muted:#64748b;--panel:#ffffff;--border:#e2e8f0;--brand:#12b4a6;--brand2:#3bb3df;--ok:#10b981;--ng:#ef4444;--shadow:0 10px 30px rgba(17,24,39,.08)}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,'Noto Sans JP',sans-serif;background:linear-gradient(180deg,#f7fbff 0%,#fbffff 100%);color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;padding:14px 18px}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#ffffff,rgba(255,255,255,.85));backdrop-filter: blur(6px);border-bottom:1px solid var(--border)}
.brand{display:flex;gap:10px;align-items:center;font-weight:800}
.progress{height:10px;background:#e5f3ff;border-radius:999px;overflow:hidden}.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2));transition: width .3s ease}
.btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:14px}
.btn.primary{background:var(--brand);color:#fff;border:none}
.muted{color:var(--muted)}.card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow)}
.card .head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.card .body{padding:16px}.grid{display:grid;gap:12px}.two{grid-template-columns:1fr 1fr}
</style>
</head><body>
<header><div class="wrap" style="display:flex;align-items:center;justify-content:space-between;">
  <div class="brand"><img src="assets/logo.svg" width="24" height="24"><span>学習アプリ</span></div>
  <div style="display:flex;gap:10px;align-items:center;">
    <a class="btn" href="index.html">ホーム</a>
    <a class="btn" href="auth.html">ログイン</a>
    <div class="progress" style="width:220px;"><div id="bar" class="bar"></div></div>
    <div id="pct" style="min-width:48px;text-align:right;">0%</div>
  </div>
</div></header>
<main class="wrap">
  <div class="card"><div class="head"><div id="day_title">Day</div><div class="btn" onclick="openDays()">Day一覧</div></div><div class="body">
    <p class="muted" id="scene">読み込み中…</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div>
        <label>借方科目</label><input id="dK" value="売掛金">
        <label>借方金額</label><input id="dA" placeholder="110000">
      </div>
      <div>
        <label>貸方科目</label><input id="cK" value="売上高">
        <label>貸方金額</label><input id="cA" placeholder="100000">
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end;">
      <button class="btn" onclick="skipDay()">スキップ</button>
      <button class="btn primary" id="grade">採点</button>
    </div>
    <div id="msg" class="muted" style="margin-top:8px;"></div>
  </div></div>
  <div class="card" style="margin-top:12px;"><div class="body"><div id="days" class="muted"></div></div></div>
</main>
<script type="module">
import { supa, getUser, saveProgress, loadProgressAll } from './supa.js';

// ---- レッスン（lessons.json からロード：存在しない場合はデモ1件）
let DAYS = [];
try {
  const res = await fetch('lessons.json', { cache:'no-store' });
  const data = await res.json();
  DAYS = data.days || [];
} catch(e) {
  DAYS = [{
    id:'d1', title:'Day1 請求の計上（デモ）',
    scene:['B社に税抜100,000円で請求（消費税10%）。売掛金を計上します。'],
    expects:[{dK:'売掛金', dA:110000, cK:'売上高', cA:100000}],
    hint:'借方 売掛金110,000 / 貸方 売上高100,000（内税なら売上高110,000でもOK）'
  }];
}

let idx = 0;
const SKEY='keiri_progress_total';
let local = JSON.parse(localStorage.getItem(SKEY) || '{"done":0,"total":'+DAYS.length+'}');
local.total = DAYS.length;
function setBar() {
  const p = Math.round((local.done / Math.max(local.total,1)) * 100);
  document.getElementById('bar').style.width = p+'%';
  document.getElementById('pct').textContent = p+'%';
}
function renderDay(i=0){
  idx=i;
  const d = DAYS[i];
  document.getElementById('day_title').textContent = d.title || ('Day'+(i+1));
  document.getElementById('scene').textContent = (d.scene && d.scene[0]) || '';
  document.getElementById('dK').value = (d.expects?.[0]?.dK) || '売掛金';
  document.getElementById('cK').value = (d.expects?.[0]?.cK) || '売上高';
  document.getElementById('dA').value = '';
  document.getElementById('cA').value = '';
}
function openDays(){
  document.getElementById('days').innerHTML = DAYS.map((d,i)=> `<button class="btn" onclick="location.href='#'">${i+1}. ${d.title}</button>`).join(' ');
}
window.openDays = openDays;

// ---- サーバ進捗をロード（ログイン済みなら）
async function hydrateFromServer(){
  try{
    const user = await getUser();
    if(!user) { setBar(); renderDay(0); return; }
    const rows = await loadProgressAll();
    if(Array.isArray(rows) && rows.length){
      const maxDone = Math.max(...rows.filter(r=>r.status==='done').map(r=>r.day_index||0), 0);
      local.done = Math.max(local.done, maxDone);
      localStorage.setItem(SKEY, JSON.stringify(local));
    }
  }catch(e){ console.warn(e); }
  setBar(); renderDay(local.done);
}
hydrateFromServer();

// ---- 採点
function roughlyEqual(a,b){ return Math.abs((+a)-(+b))<=1; }
document.getElementById('grade').onclick = async () => {
  const d = DAYS[idx] || {};
  const dK = document.getElementById('dK').value.trim();
  const cK = document.getElementById('cK').value.trim();
  const dA = Number(document.getElementById('dA').value);
  const cA = Number(document.getElementById('cA').value);
  let ok=false;
  for(const ex of (d.expects||[])){
    const dk = ex.dK ? dK===ex.dK : true;
    const ck = ex.cK ? cK===ex.cK : true;
    const da = (typeof ex.dA==='number') ? dA===ex.dA : ex.dAAny ? ex.dAAny.some(x=>roughlyEqual(x,dA)) : true;
    const ca = (typeof ex.cA==='number') ? cA===ex.cA : ex.cAAny ? ex.cAAny.some(x=>roughlyEqual(x,cA)) : true;
    if(dk&&ck&&da&&ca){ ok=true; break; }
  }
  const msg = document.getElementById('msg');
  if(!ok){ msg.innerHTML = '× もう一歩。'+(d.hint||''); return; }
  msg.innerHTML = '◎ 正解！';
  if(local.done < idx+1){
    local.done = idx+1;
    localStorage.setItem(SKEY, JSON.stringify(local));
    setBar();
  }
  // サーバ保存（ログイン済みなら）
  if(supa){
    try{
      await saveProgress({ dayIndex: idx+1, status:'done', attempts:1, elapsedSeconds:30, lastAnswer:{dK,dA,cK,cA} });
      msg.innerHTML += '（サーバにも保存しました）';
    }catch(e){ console.warn(e); msg.innerHTML += '（未ログイン or サーバ保存エラー）'; }
  }
};

function skipDay(){
  const msg = document.getElementById('msg');
  msg.textContent = 'スキップしました。';
  if(local.done < idx+1){
    local.done = idx+1;
    localStorage.setItem(SKEY, JSON.stringify(local));
    setBar();
  }
}
window.skipDay = skipDay;
</script>
</body></html>
